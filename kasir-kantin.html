<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRO KASIR - E-Kantin SDN 169</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .cart-gradient { background: linear-gradient(135deg, #4338ca 0%, #312e81 100%); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="max-w-6xl mx-auto p-4">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="bg-indigo-900 p-5 px-8 rounded-[2.5rem] text-white shadow-2xl flex-1 w-full border-b-4 border-yellow-400 relative overflow-hidden">
                <div class="relative z-10">
                    <h1 class="text-xl font-extrabold italic uppercase tracking-tighter text-yellow-400">Kasir Pintar SDN 169 üöÄ</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                        <p class="text-[9px] font-bold opacity-70 uppercase tracking-widest">WhatsApp Gateway Fonnte Ready</p>
                    </div>
                </div>
                <div class="absolute right-[-10px] bottom-[-10px] text-white/5 text-6xl font-black italic">POS</div>
            </div>
            <button onclick="window.location.href='index.html'" class="bg-white px-8 py-5 rounded-[2rem] shadow-lg font-black text-indigo-900 text-xs hover:bg-slate-50 transition-all border border-slate-100 uppercase tracking-widest">üè† Portal Utama</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-8 order-2 lg:order-1" id="menuContainer">
                <div class="flex items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
                </div>
            </div>

            <div class="lg:col-span-4 order-1 lg:order-2">
                <div class="bg-white p-6 rounded-[3rem] shadow-2xl sticky top-6 border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-black text-slate-400 text-[10px] uppercase tracking-[0.3em]">Ringkasan Pesanan</h2>
                        <span id="cartCount" class="bg-indigo-100 text-indigo-600 text-[10px] font-black px-2 py-1 rounded-lg">0 ITEM</span>
                    </div>

                    <div id="cartItems" class="space-y-3 mb-6 max-h-[350px] overflow-y-auto custom-scroll pr-2 italic">
                        <p class="text-center py-10 text-slate-300 text-[10px] font-bold uppercase tracking-widest">Keranjang Kosong</p>
                    </div>
                    
                    <div class="bg-slate-50 p-6 rounded-[2rem] mb-6 border-2 border-dashed border-slate-200">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Tagihan</span>
                            <span id="totalHarga" class="text-3xl font-black text-indigo-700 tracking-tighter">Rp 0</span>
                        </div>
                    </div>

                    <div id="scannerArea" class="hidden mb-6 animate-in zoom-in duration-300">
                        <div id="reader" class="rounded-[2rem] overflow-hidden border-4 border-indigo-600 shadow-2xl shadow-indigo-200 bg-black"></div>
                        <div class="bg-red-50 text-red-500 p-3 rounded-xl mt-3 text-center">
                            <p class="text-[9px] font-black uppercase tracking-tighter animate-pulse">‚ö° Sedang Menunggu QR Card Siswa...</p>
                        </div>
                    </div>

                    <button id="btnCheckout" onclick="bukaScanner()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-black py-5 rounded-[2rem] shadow-xl shadow-emerald-100 transition-all uppercase text-xs tracking-widest active:scale-95">
                        BAYAR SEKARANG ‚úÖ
                    </button>
                    
                    <button onclick="resetCart()" class="w-full mt-4 text-slate-300 hover:text-red-400 font-bold text-[9px] uppercase transition-colors tracking-widest">Batal / Kosongkan</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="sndBeep" src="https://assets.mixkit.co/active_storage/sfx/700/700-preview.mp3"></audio>

    <script>
        // CONFIG FIREBASE BAPAK
        const firebaseConfig = {
            apiKey: "AIzaSyCUjE8WXa8Py4vnojrXDUR3uCvnQEzP6zQ",
            authDomain: "e-kantin-91f0c.firebaseapp.com",
            databaseURL: "https://e-kantin-91f0c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "e-kantin-91f0c",
            storageBucket: "e-kantin-91f0c.firebasestorage.app",
            messagingSenderId: "981834126006",
            appId: "1:981834126006:web:dac8bb0ec1da90549b4c17"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let cart = []; 
        let total = 0;
        const FONNTE_TOKEN = "RjMyF3NyoVWPXC2SGKCu"; 

        // LOAD MENU SECARA REAL-TIME
        db.ref('kantin_menus').on('value', snap => {
            const container = document.getElementById('menuContainer'); 
            container.innerHTML = "";
            
            snap.forEach(stanSnap => {
                let html = `<div class="mb-10">
                    <div class="flex items-center gap-3 mb-5 ml-4">
                        <div class="h-8 w-1 bg-indigo-600 rounded-full"></div>
                        <h3 class="text-sm font-black text-indigo-900 uppercase tracking-tighter">Stan: ${stanSnap.key}</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                
                stanSnap.forEach(mSnap => {
                    const m = mSnap.val();
                    const sisa = (m.stok_awal - (m.terjual || 0));
                    const habis = sisa <= 0;
                    
                    html += `
                        <button onclick="${habis ? "alert('Maaf, Stok Habis!')" : `addToCart('${stanSnap.key}','${m.nama}',${m.harga},'${mSnap.key}')`}" 
                            class="group bg-white p-5 rounded-[2rem] flex justify-between items-center transition-all border-2 border-transparent hover:border-indigo-400 shadow-sm hover:shadow-xl active:scale-95 ${habis ? 'opacity-40 grayscale cursor-not-allowed' : ''}">
                            <div class="text-left">
                                <p class="text-[11px] font-extrabold uppercase text-slate-800 tracking-tighter">${m.nama}</p>
                                <p class="text-sm font-black text-emerald-600">Rp ${m.harga.toLocaleString()}</p>
                            </div>
                            <div class="bg-slate-50 px-3 py-2 rounded-2xl text-center group-hover:bg-indigo-50 transition-colors">
                                <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Stok</p>
                                <p class="text-xs font-black ${sisa < 5 ? 'text-red-500' : 'text-slate-700'}">${sisa < 0 ? 0 : sisa}</p>
                            </div>
                        </button>`;
                });
                container.innerHTML += html + `</div></div>`;
            });
        });

        function addToCart(stan, nama, harga, idMenu) { 
            cart.push({ stan, nama, harga, idMenu }); 
            updateCartDisplay();
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function updateCartDisplay() {
            const cont = document.getElementById('cartItems'); 
            const countLabel = document.getElementById('cartCount');
            cont.innerHTML = ""; 
            total = 0;

            if(cart.length === 0) {
                cont.innerHTML = `<p class="text-center py-10 text-slate-300 text-[10px] font-bold uppercase tracking-widest">Keranjang Kosong</p>`;
            }

            cart.forEach((item, index) => { 
                total += item.harga; 
                cont.innerHTML += `
                    <div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100 animate-in slide-in-from-right duration-300">
                        <div>
                            <p class="text-[10px] font-black uppercase text-slate-800 tracking-tighter">${item.nama}</p>
                            <p class="text-[9px] font-bold text-emerald-600 tracking-widest">Rp ${item.harga.toLocaleString()}</p>
                        </div>
                        <button onclick="removeItem(${index})" class="h-8 w-8 flex items-center justify-center bg-white text-red-400 rounded-full shadow-sm hover:bg-red-500 hover:text-white transition-all">√ó</button>
                    </div>`; 
            });
            document.getElementById('totalHarga').innerText = "Rp " + total.toLocaleString();
            countLabel.innerText = cart.length + " ITEM";
        }

        function removeItem(idx) { cart.splice(idx,1); updateCartDisplay(); }
        function resetCart() { cart = []; updateCartDisplay(); }

        let scanner;
        function bukaScanner() {
            if(cart.length === 0) return alert("Pilih menu dulu, Pak!");
            document.getElementById('scannerArea').classList.remove('hidden');
            document.getElementById('btnCheckout').innerText = "MENUNGGU SCAN CARD...";
            
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 220 }, (id) => { 
                document.getElementById('sndBeep').play();
                scanner.stop().then(() => {
                    document.getElementById('scannerArea').classList.add('hidden');
                    document.getElementById('btnCheckout').innerText = "BAYAR SEKARANG ‚úÖ";
                    prosesBayar(id.trim()); 
                });
            }).catch(err => {
                alert("Kamera Error: " + err);
                document.getElementById('scannerArea').classList.add('hidden');
            });
        }

        function prosesBayar(idSiswa) {
            db.ref('kantin_users/' + idSiswa).once('value', userSnap => {
                const user = userSnap.val();
                if(!user) return alert("‚ùå SISWA TIDAK TERDAFTAR!");
                if(user.saldo < total) return alert("‚ùå SALDO KURANG!\nSaldo " + user.nama + " hanya Rp " + user.saldo.toLocaleString());

                const saldoBaru = user.saldo - total;
                const waktu = new Date().toLocaleString('id-ID');
                let detailItems = "";
                let itemLog = [];

                // 1. UPDATE STOK MENU
                cart.forEach(item => {
                    detailItems += `‚Ä¢ ${item.nama} (Rp ${item.harga.toLocaleString()})\n`;
                    itemLog.push(item.nama);
                    
                    const menuRef = db.ref(`kantin_menus/${item.stan}/${item.idMenu}`);
                    menuRef.transaction(c => { 
                        if(c){ c.terjual = (c.terjual || 0) + 1; } 
                        return c; 
                    });
                });

                // 2. UPDATE SALDO SISWA
                db.ref('kantin_users/' + idSiswa + '/saldo').set(saldoBaru);

                // 3. CATAT LAPORAN HARIAN
                db.ref('kantin_laporan').push({ 
                    idSiswa, 
                    namaSiswa: user.nama, 
                    total, 
                    item: itemLog.join(", "), 
                    waktu 
                });

                // 4. KIRIM STRUK WHATSAPP
                if (user.wa) {
                    const pesan = `*STRUK DIGITAL E-KANTIN*\n*SDN 169 CINTA DAMAI*\n\nAnanda: *${user.nama}*\n\n*Detail Belanja:*\n${detailItems}\n*TOTAL BAYAR: Rp ${total.toLocaleString()}*\n*SISA SALDO: Rp ${saldoBaru.toLocaleString()}*\n\n_Terima kasih telah berbelanja secara digital!_`;
                    
                    fetch('https://api.fonnte.com/send', { 
                        method: 'POST', 
                        headers: { 'Authorization': FONNTE_TOKEN }, 
                        body: new URLSearchParams({ 'target': user.wa, 'message': pesan }) 
                    });
                }
                
                alert(`‚úÖ BERHASIL!\n\nNama: ${user.nama}\nBelanja: Rp ${total.toLocaleString()}\nSisa Saldo: Rp ${saldoBaru.toLocaleString()}`);
                resetCart();
            });
        }
    </script>
</body>
</html>
